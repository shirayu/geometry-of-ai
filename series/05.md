# 第5回：分類の再統一 II ～マージンの幾何学～

## 注意事項

- ArcFaceの「角度マージン」は、特徴ベクトルと重みベクトルが $L_2$ 正規化されていることが前提。
- SVMとの「統一」は幾何学的直感の共有であり、最適化問題として同一ではない。
- 「球面上のSVM」という解釈は比喩として有用だが、厳密な対応ではない点に注意。

## トピック

ArcFace と SVM の和解

## 内容

- **SVMの魂を振り返る:**
    - 「境界から最も遠い点」を見つける = 最大マージン原理
    - ユークリッド空間でのマージン：直線（超平面）からの距離
    - 数式： $\max \frac{2}{|\mathbf{w}|}$ subject to $y_i(\mathbf{w}^T\mathbf{x}_i + b) \geq 1$
- **球面上でのマージン（設計として）:**
    - 境界は測地線（大円）
    - マージンは角度で測る
    - 「同じクラスの点は近く（角度が小さく）、異なるクラスは遠く（角度が大きく）」
- **ArcFaceの革命:**
    - 従来のSoftmax： $\cos\theta$ に基づく分類（※正規化設計と相性）
    - ArcFace： $\cos(\theta + m)$ に基づく分類
        - $m$ : 角度マージン（例：0.5ラジアン ≈ 28.6度）
        - 同じクラス内の点を「さらに $m$ だけ近づける」強制力
    - これは**「固定した角度マージン m を損失に組み込み分離を強める」**設計であり、
      幾何学的にはSVM的マージン発想と**類似の直感**を与える（ただし最適化問題として同一ではない）
    - ※ArcFace: CVPR 2019発表、現在も顔認識の標準手法として広く使用

- **数式の対応:**

    | 空間 | マージン | 最適化目標 |
    | --- | --- | --- |
    | ユークリッド（SVM） | 距離 $d$ | $\max d$ |
    | 球面（ArcFace） | 角度 $m$ | 角度マージン $m$ を課す / 分離を強める |

- **過去の対立の解消（見方として）:**
    - 幾何（SVM）：決定境界を明示的に扱う
    - 統計（Softmax）：確率分布として扱う
    - **角度・確率の両方を扱う設計ではこの二つが融合して見える**
        - 角度マージン = 幾何学的制約
        - Softmax = 統計的解釈
        - ArcFace = 両者の統合例

## 洞察

座標系（制約）を選ぶと、対立が「別表現」に見えてくる

## 実装ノート

- ArcFaceの実装（教材用の直感的形）:
    - `torch.cos(torch.acos(torch.clamp(cosine, -1+1e-7, 1-1e-7)) + margin)`
    - **重要:** `cosine`を`[-1, 1]`に`clamp`しないと数値誤差でNaNになりうる
- 安定計算の代替（推奨の考え方）:
    - $cos(\theta+m) = cos(\theta)cos(m) - sin(\theta)sin(m)$ を用いる
    - 実際の実装はさらに数値安定化が施されることが多い
